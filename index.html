<!DOCTYPE html>
<html lang="EN">

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
</head>

<body>
  <h1>MQTT Client</h1>
  <button id="connect">Connect</button>
  <ul id="chat">
    <li v-for="m in messages">{{ m }}</li>
  </ul>
  <input type="text" name="say" id="say" placeholder="Input a message here...">
  <button id="send">Send</button>
  <h2>user1</h2>
  <HR width=100% color=#987cb9 SIZE=2>
  <div>
    <canvas style="width: 100%;" id="canvas_1"></canvas>
  </div>
  <HR width=100% color=#987cb9 SIZE=2>
  <h2>user2</h2>
  <HR width=100% color=#987cb9 SIZE=2>
  <div>
    <canvas style="width: 100%;" id="canvas_2""></canvas>
    </div>
    <HR width=100% color=#987cb9 SIZE=2>
  <script src=" https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.16/vue.min.js" type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"
        type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js"
        type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/hmac-min.js"
        type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/sha256-min.js"
        type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
      <script src="https://cdn.jsdelivr.net/gh/danchitnis/webgl-plot@master/dist/webglplot.umd.min.js"></script>
      <script type="text/javascript">
        var data = {
          messages: []
        };

        new Vue({
          el: '#chat',
          data: data
        });

        document.getElementById('send').addEventListener('click', function (e) {
          var say = document.getElementById('say')
          send(say.value);
          say.value = '';
        });
        document.getElementById('connect').addEventListener('click', function (e) {
          client.connect(connectOptions);
          client.onMessageArrived = onMessage;
          client.onConnectionLost = function (e) { console.log(e) };
        });

        function SigV4Utils() { }

        SigV4Utils.sign = function (key, msg) {
          var hash = CryptoJS.HmacSHA256(msg, key);
          return hash.toString(CryptoJS.enc.Hex);
        };

        SigV4Utils.sha256 = function (msg) {
          var hash = CryptoJS.SHA256(msg);
          return hash.toString(CryptoJS.enc.Hex);
        };

        SigV4Utils.getSignatureKey = function (key, dateStamp, regionName, serviceName) {
          var kDate = CryptoJS.HmacSHA256(dateStamp, 'AWS4' + key);
          var kRegion = CryptoJS.HmacSHA256(regionName, kDate);
          var kService = CryptoJS.HmacSHA256(serviceName, kRegion);
          var kSigning = CryptoJS.HmacSHA256('aws4_request', kService);
          return kSigning;
        };

        function createEndpoint(regionName, awsIotEndpoint, accessKey, secretKey) {
          var time = moment.utc();
          var dateStamp = time.format('YYYYMMDD');
          var amzdate = dateStamp + 'T' + time.format('HHmmss') + 'Z';
          var service = 'iotdevicegateway';
          var region = regionName;
          var secretKey = secretKey;
          var accessKey = accessKey;
          var algorithm = 'AWS4-HMAC-SHA256';
          var method = 'GET';
          var canonicalUri = '/mqtt';
          var host = awsIotEndpoint;

          var credentialScope = dateStamp + '/' + region + '/' + service + '/' + 'aws4_request';
          var canonicalQuerystring = 'X-Amz-Algorithm=AWS4-HMAC-SHA256';
          canonicalQuerystring += '&X-Amz-Credential=' + encodeURIComponent(accessKey + '/' + credentialScope);
          canonicalQuerystring += '&X-Amz-Date=' + amzdate;
          canonicalQuerystring += '&X-Amz-SignedHeaders=host';

          var canonicalHeaders = 'host:' + host + '\n';
          var payloadHash = SigV4Utils.sha256('');
          var canonicalRequest = method + '\n' + canonicalUri + '\n' + canonicalQuerystring + '\n' + canonicalHeaders + '\nhost\n' + payloadHash;

          var stringToSign = algorithm + '\n' + amzdate + '\n' + credentialScope + '\n' + SigV4Utils.sha256(canonicalRequest);
          var signingKey = SigV4Utils.getSignatureKey(secretKey, dateStamp, region, service);
          var signature = SigV4Utils.sign(signingKey, stringToSign);

          canonicalQuerystring += '&X-Amz-Signature=' + signature;
          return 'wss://' + host + canonicalUri + '?' + canonicalQuerystring;
        }

        var endpoint = createEndpoint(
          'eu-west-2', // Your Region
          'X', // Require 'lowercamelcase'!!
          'X',
          'X');
        var clientId = Math.random().toString(36).substring(7);
        var client = new Paho.MQTT.Client(endpoint,S clientId);
        var connectOptions = {
          useSSL: true,
          timeout: 3,
          mqttVersion: 4,
          onSuccess: subscribe
        };


        const canvas = document.getElementById("canvas_1");
        const devicePixelRatio = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * devicePixelRatio;
        canvas.height = canvas.clientHeight * devicePixelRatio;

        const numX = canvas.width;
        const color = new WebglPlotBundle.ColorRGBA(
          Math.random(),
          Math.random(),
          Math.random(),
          1
        );
        const line = new WebglPlotBundle.WebglLine(color, numX);
        const wglp = new WebglPlotBundle.WebglPlot(canvas);
        line.lineSpaceX(-1, 2 / numX);
        wglp.addLine(line);

        function initialFrame() {
          line.constY(0);
          wglp.update();
        }
        requestAnimationFrame(initialFrame);

        const canvas2 = document.getElementById("canvas_2");
        canvas2.width = canvas2.clientWidth * devicePixelRatio;
        canvas2.height = canvas2.clientHeight * devicePixelRatio;
        const color2 = new WebglPlotBundle.ColorRGBA(
          Math.random(),
          Math.random(),
          Math.random(),
          1
        );
        const line2 = new WebglPlotBundle.WebglLine(color2, numX);
        const wglp2 = new WebglPlotBundle.WebglPlot(canvas2);
        line2.lineSpaceX(-1, 2 / numX);
        wglp2.addLine(line2);
        function initialFrame2() {
          line2.constY(0);
          wglp2.update();
        }
        requestAnimationFrame(initialFrame2);


        function byteArrayToIntArray(byteArray) {
          var intArray = new Array(10);
          var j = 0;
          for (var i = 0; i < byteArray.length; i = i + 2) {
            var byteA = byteArray[i];
            var byteB = byteArray[i + 1];
            var sign = byteB & (1 << 7);
            var x = (((byteB & 0xFF) << 8) | (byteA & 0xFF));
            var result;
            if (sign) {
              result = 0xFFFF0000 | x;  // fill in most significant bits with 1's
            } else {
              result = x;
            }
            intArray[j] = result;
            j = j + 1;
          }
          return intArray;
        }

        function normalize(array) {
          var arr = new Array(10);
          for (let i = 0; i < array.length; i++) {
            arr[i] = 2 * (array[i] - Math.min.apply(Math, array)) / (Math.max.apply(Math, array) - Math.min.apply(Math, array)) - 1;
          }
          return arr;
        }

        function subscribe() {
          client.subscribe("esp32/+");
          console.log("subscribed");
        }

        function send(content) {
          var message = new Paho.MQTT.Message(content);
          message.destinationName = "esp32/+";
          client.send(message);
          console.log("sent");
        }
        function onMessage(message) {
          var payload = message.payloadBytes;
          var length = payload.length;
          var msg = byteArrayToIntArray(payload);
          var counter = msg[0];
          var user_id = msg[1];
          var channel_code = msg[2];
          var eeg_data_len = msg[3];
          var eeg_data = msg.slice(4, 4 + eeg_data_len);


          //data.messages.push(msg);
          console.log(message.destinationName);
          console.log("message received: " + length);
          console.log("message received: " + eeg_data_len);
          console.log("message received: " + eeg_data);

          function newFrame() {
            update(eeg_data, user_id);
            wglp.update();
          }
          function newFrame2() {
            update(eeg_data, user_id);
            wglp2.update();
          }
          function update(data, user_id) {
            var arr = new Float32Array(data);
            if (user_id == 1) {
              line.shiftAdd(normalize(arr));
            } else if (user_id == 2) {
              line2.shiftAdd(normalize(arr));
            }
          }
          if (user_id == 1) {
            requestAnimationFrame(newFrame);
          } else if (user_id == 2) {
            requestAnimationFrame(newFrame2);
          }
        }

      </script>
</body>

</html>